<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">כל המאמרים - אור בפרשה</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { beigeTheme: '#f1dcc1' },
                    fontFamily: {
                        sans: ['Heebo', 'sans-serif'],
                        titleFont: ['NoaShalev', 'serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @font-face { font-family: 'OHLiorAtias'; src: url('OHLiorAtias-Regular.ttf') format('truetype'); }
        @font-face { font-family: 'NoaShalev'; src: url('noa-shalev-regular-AlefAlefAlef.otf') format('opentype'); }

        body { 
            background: linear-gradient(to bottom, white 0%, white 15%, #f1dcc1 60%, #f1dcc1 100%);
            margin: 0; overflow-x: hidden; min-height: 100vh;
        }
        .floating-card { 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; background-color: white; 
        }
        .floating-card:hover { 
            box-shadow: 0 25px 45px -10px rgba(0, 0, 0, 0.12);
            transform: translateY(-8px);
        }
        .hero-mask {
            mask-image: linear-gradient(to bottom, black 75%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, black 75%, transparent 100%);
        }
        .custom-subtitle-font {
            font-family: 'OHLiorAtias', sans-serif;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .main-title-font { font-family: 'NoaShalev', serif; }
        .loader-spinner {
            width: 50px; height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #64748b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="font-sans antialiased text-slate-800">

    <div id="hero-section" class="fixed top-0 left-0 w-full h-[50vh] z-0 overflow-hidden hero-mask">
        <div id="hero-bg" class="absolute inset-0 bg-cover bg-center" style="background-image: url('images/index_image_desktop.png');"></div>
        <div class="absolute inset-0 bg-black/40"></div>
        
        <div class="absolute top-8 right-8 z-20">
            <a href="index.html" class="inline-flex items-center gap-2 font-bold text-sm bg-white/20 backdrop-blur-md px-5 py-2.5 rounded-full hover:bg-white/40 transition-all no-underline text-white border border-white/30">
                <span class="material-symbols-outlined text-lg">arrow_forward</span>
                חזרה לראשי
            </a>
        </div>

        <div class="absolute inset-0 flex flex-col items-center justify-center text-white text-center px-6">
            <h1 class="main-title-font text-5xl md:text-7xl font-bold drop-shadow-2xl mb-4">כל המאמרים</h1>
            <p class="text-xl md:text-2xl font-light opacity-95 drop-shadow-lg">המאמרים החדשים ביותר בראש הרשימה</p>
        </div>
    </div>

    <div class="relative z-10 mt-[50vh]">
        <div class="pb-24 px-6">
            <main class="max-w-4xl mx-auto">
                <div id="loader-container" class="text-center py-20 flex flex-col items-center">
                    <div class="loader-spinner"></div>
                    <p class="text-xl font-medium text-slate-600">ממיין מאמרים לפי זמן פרסום...</p>
                </div>

                <div id="parasha-grid" class="flex flex-col gap-8 hidden"></div>
            </main>
        </div>
    </div>

    <script>
        const booksConfig = {
            'bereshit': { color: '#10b981', dark: '#065f46', folder: 'bereshit', parashot: ['Bereshit', 'Noach', 'Lech Lecha', 'Vayeira', 'Chayei Sarah', 'Toledot', 'Vayetzei', 'Vayishlach', 'Vayeshev', 'Miketz', 'Vayigash', 'Vayechi'] },
            'shmot': { color: '#f97316', dark: '#9a3412', folder: 'shmot', parashot: ['Shemot', 'Vaera', 'Bo', 'Beshalach', 'Yitro', 'Mishpatim', 'Terumah', 'Tetzaveh', 'Ki Tisa', 'Vayakhel', 'Pekudei'] },
            'vaikra': { color: '#a855f7', dark: '#6b21a8', folder: 'vaikra', parashot: ['Vayikra', 'Tzav', 'Shemini', 'Tazria', 'Metzora', 'Acharei Mot', 'Kedoshim', 'Emor', 'Behar', 'Bechukotai'] },
            'bamidbar': { color: '#d97706', dark: '#92400e', folder: 'bamidbar', parashot: ['Bamidbar', 'Nasso', 'Beha\'alotcha', 'Shelach', 'Korach', 'Chukat', 'Balak', 'Pinchas', 'Matot', 'Masei'] },
            'devarim': { color: '#0284c7', dark: '#075985', folder: 'devarim', parashot: ['Devarim', 'Va\'etchanan', 'Eikev', 'Reeh', 'Shoftim', 'Ki Teitzei', 'Ki Tavo', 'Nitzavim', 'Vayeilech', 'Haazinu', 'VZot HaBerachah'] }
        };

        const monthMap = { 
            "תשרי": 1, "חשון": 2, "חשוון": 2, "כסלו": 3, "טבת": 4, "שבט": 5, "אדר": 6, "אדר א": 6, "אדר ב": 6.5,
            "ניסן": 7, "אייר": 8, "סיון": 9, "סיוון": 9, "תמוז": 10, "אב": 11, "אלול": 12 
        };

        function gimatriaToNum(str) {
            if(!str) return 0;
            const cleanStr = str.replace(/[׳״'"]/g, '');
            const map = {'א':1,'ב':2,'ג':3,'ד':4,'ה':5,'ו':6,'ז':7,'ח':8,'ט':9,'י':10,'יא':11,'יב':12,'יג':13,'יד':14,'טו':15,'טז':16,'יז':17,'יח':18,'יט':19,'כ':20,'כא':21,'כב':22,'כג':23,'כד':24,'כה':25,'כו':26,'כז':27,'כח':28,'כט':29,'ל':30};
            return map[cleanStr] || parseInt(cleanStr) || 0;
        }

        function parseHebrewDate(dateStr, timeStr) {
            if (!dateStr || dateStr.trim() === "") return 0;
            try {
                const parts = dateStr.trim().split(/\s+/);
                if (parts.length < 3) return 0;

                const day = gimatriaToNum(parts[0]);
                const month = monthMap[parts[1].replace(/[׳״'"]/g, '')] || 0;
                
                let yearRaw = parts[2].replace(/[׳״'"]/g, '');
                let year = 0;
                if (yearRaw.includes('תש')) {
                    const yearSuffix = yearRaw.slice(-1);
                    const yearBaseMap = {'א':5781,'ב':5782,'ג':5783,'ד':5784,'ה':5785,'ו':5786,'ז':5787};
                    year = yearBaseMap[yearSuffix] || 5700;
                } else { year = parseInt(yearRaw) || 0; }

                let timeValue = 0;
                if (timeStr && timeStr.includes(':')) {
                    const [h, m] = timeStr.split(':').map(n => parseInt(n) || 0);
                    timeValue = (h * 0.01) + (m * 0.0001);
                }

                // מחזיר מספר גדול מאוד עבור תאריך קיים
                return (year * 10000) + (month * 100) + day + timeValue;
            } catch { return 0; }
        }

        function parseArticle(text, bookKey) {
            const data = { bookKey, title: '', subtitle: '', image: '', date: '', time: '', id: '' };
            const lines = text.split('\n');
            let content = "";
            let meta = true;
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed === '---') { meta = false; return; }
                if (meta) {
                    const sep = line.indexOf(':');
                    if (sep > -1) {
                        const key = line.substring(0, sep).trim();
                        const val = line.substring(sep + 1).trim();
                        data[key] = val;
                    }
                } else { content += trimmed; }
            });
            return (content.trim() && data.id) ? data : null;
        }

        async function loadAll() {
            const allPromises = [];
            Object.entries(booksConfig).forEach(([key, book]) => {
                book.parashot.forEach(p => {
                    const safeName = p.replace(/\s+/g, '_');
                    for (let i = 1; i <= 5; i++) {
                        allPromises.push(
                            fetch(`parashot/${book.folder}/${safeName}_${i}.txt`)
                            .then(r => r.ok ? r.text() : null)
                            .then(txt => txt ? parseArticle(txt, key) : null)
                            .catch(() => null)
                        );
                    }
                });
            });

            let articles = (await Promise.all(allPromises)).filter(a => a !== null);
            
            // המיון המתוקן - הכוח עובר לתאריך
            articles.sort((a, b) => {
                const scoreA = parseHebrewDate(a.date, a.time);
                const scoreB = parseHebrewDate(b.date, b.time);
                
                // אם לשניהם אין תאריך (ציון 0), שומרים על סדר מקורי (לפי פרשה)
                if (scoreA === 0 && scoreB === 0) return 0;
                
                // אם לאחד יש תאריך ולשני אין - זה שיש לו תאריך תמיד ראשון
                if (scoreA === 0) return 1;
                if (scoreB === 0) return -1;
                
                // אם לשניהם יש תאריך - המאוחר ביותר למעלה
                return scoreB - scoreA; 
            });

            const grid = document.getElementById('parasha-grid');
            if (articles.length === 0) {
                document.getElementById('loader-container').innerHTML = '<p class="text-slate-500">לא נמצאו מאמרים.</p>';
                return;
            }

            articles.forEach(art => {
                const cfg = booksConfig[art.bookKey];
                const card = document.createElement('div');
                card.innerHTML = `
                    <a href="article.html?parasha=${art.id}&book=${art.bookKey}" class="group relative p-[1.5px] rounded-3xl no-underline floating-card block overflow-hidden">
                        <div class="relative rounded-[calc(1.5rem-1.5px)] overflow-hidden flex items-center p-3 md:p-5 bg-white">
                            <div class="w-24 h-24 md:w-40 md:h-40 overflow-hidden flex-shrink-0 rounded-2xl border border-black/5 bg-slate-50">
                                <img src="${art.image || 'images/index_image.jpg'}" onerror="this.src='images/index_image.jpg'" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                            </div>
                            <div class="mr-4 md:mr-8 flex flex-col h-24 md:h-40 flex-grow py-1">
                                <h3 class="main-title-font text-lg md:text-2xl font-bold truncate" style="color: ${cfg.color}">${art.title}</h3>
                                <div class="flex-grow flex flex-col justify-center">
                                    <p class="custom-subtitle-font text-xl md:text-4xl font-medium" style="color: ${cfg.dark}">${art.subtitle}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-[10px] md:text-xs font-bold px-2 py-0.5 rounded-md border" style="color: ${cfg.color}; border-color: ${cfg.color}33">
                                        ${art.date || 'לא הוגדר תאריך'} ${art.time ? ' | ' + art.time : ''}
                                    </span>
                                </div>
                            </div>
                            <span class="material-symbols-outlined opacity-20 group-hover:opacity-100 transition-all ml-2" style="color: ${cfg.color}">arrow_back_ios</span>
                        </div>
                        <div class="absolute inset-0 rounded-3xl pointer-events-none" style="border: 1.5px solid transparent; background: linear-gradient(135deg, ${cfg.color}, ${cfg.dark}) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: destination-out; mask-composite: exclude;"></div>
                    </a>`;
                grid.appendChild(card);
            });

            document.getElementById('loader-container').style.display = 'none';
            grid.classList.remove('hidden');
        }

        window.onload = loadAll;
    </script>
</body>
</html>
